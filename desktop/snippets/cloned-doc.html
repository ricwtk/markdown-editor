<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="../css/md-themes.css">
    <link rel="stylesheet" type="text/css" href="../css/main.css">
    <link rel="stylesheet" type="text/css" href="../node_modules/mdi/css/materialdesignicons.min.css">
    <link id="codeblocktheme" rel="stylesheet" :href="target">
    <style id="customcss">{{ pref.customCSS }}</style>
    <script src="../js/highlight.pack.js"></script>
    <style>
    </style>
  </head>
  <body class="md-default v-box">
    <div id="container-wrapper" class="grow v-box">
      <div id="container" class="grow p-2 bg-gray-lighter overflow-auto full-width full-height" 
        onscroll="scrollDoc()" 
        v-html="compiled"
        :style="pref.font"
      ></div>
      <div id="controls" class="h-box p-1 bg-gray-light">
        <div class="grow"></div>
        <div class="button-group">
          <button class="btn" data-tooltip="Clone" onclick="createClone()"><i class="mdi mdi-checkbox-multiple-blank-outline"></i></button>
          <button class="btn" data-tooltip="Present" onclick="toggleFullscreen()"><i class="mdi mdi-presentation-play"></i></button>
        </div>
      </div>
    </div>

    <script>
      const path = require("path");
      const showdown = require("showdown");
      const Vue = require(path.join(__dirname, "..", "js", "vue.min.js"));
      require(path.join(__dirname, "..", "js", "showdown-timeline-ext.js"));
      require(path.join(__dirname, "..", "js", "showdown-highlightjs-ext.js"));
      const mdconverter = require(path.join(__dirname, "..", "js", "md-converter.js"));
      var docClone;
      var pref = {
        source: "",
        font: {},
        codeBlockTheme: "",
        customCSS: ""
      }
      new Vue({
        el: "#codeblocktheme",
        data: { pref: pref }, 
        computed: { target: function () { return pref.codeBlockTheme ? "../css/highlight/" + pref.codeBlockTheme + ".css" : "" } }
      });
      new Vue({
        el: "#customcss",
        data: { pref: pref }
      })
      new Vue({
        el: "#container",
        data: {
          pref: pref
        },
        computed: {
          compiled: function () {
            return mdconverter.makeHtml(this.pref.source);
          }
        },
        watch: {
          "source": function () {
            if (docClone && !docClone.closed) {
              docClone.postMessage({
                msg: "set-source",
                title: "Cloned: " + document.title,
                content: this.source,
                font: font,
                codeBlockTheme: codeBlockTheme,
                customCSS: customCSS
              }, "*");
            }
          }
        }
      })

      window.addEventListener("load", () => {
        window.opener.postMessage("doc-clone-loaded", "*");
      });

      window.addEventListener("message", (ev) => {
        if (ev.data.msg == "set-source") {
          document.title = ev.data.title;

          pref.source = ev.data.content;
          pref.codeBlockTheme = ev.data.codeBlockTheme;
          pref.font = ev.data.font;
          pref.customCSS = ev.data.customCSS;
        } else if (ev.data == "doc-clone-loaded") {
          ev.source.postMessage({
            msg: "set-source",
            title: "Cloned: " + document.title,
            content: pref.source,
            font: pref.font,
            codeBlockTheme: pref.codeBlockTheme,
            customCSS: pref.customCSS
          }, "*");
        } else if (ev.data.msg == "scroll-top") {
          let el = document.getElementById("container");
          el.scrollTop = ev.data.scrollTop;
        }
      });

      function toggleFullscreen() {
        document.getElementById("container").webkitRequestFullscreen();
      }

      function createClone() {
        if (!docClone || docClone.closed) {
          docClone = window.open(window.location, "Cloned: " + document.title, 'menubar=no,location=no');
        } else {
          docClone.focus();
        }
      }

      function scrollDoc() {
        let el = document.getElementById("container");
        msg = { msg: "scroll-top", scrollTop: el.scrollTop };
        if (window.opener) {
          window.opener.postMessage(msg);
        }
        if (docClone) {
          docClone.postMessage(msg);
        }
      }
    </script>
  </body>
</html>