<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="../css/md-themes.css">
    <script src="../js/highlight.pack.js"></script>
    <script src="../js/remark.min.js"></script>
  </head>
  <body class="md-default">
    <textarea id="source"></textarea>
    <script>
      const path = require("path");
      const showdown = require("showdown");
      require(path.join(__dirname, "..", "js", "showdown-timeline-ext.js"));
      require(path.join(__dirname, "..", "js", "showdown-highlightjs-ext.js"));
      const mdconverter = require(path.join(__dirname, "..", "js", "md-converter.js"));

      window.addEventListener("load", () => {
        window.opener.postMessage("clone-loaded", "*");
      });

      window.addEventListener("message", (ev) => {
        if (ev.data.msg == "set-source") {
          document.getElementById("source").innerHTML = ev.data.content;
          let head = document.querySelector("head");

          let eel = head.querySelector("#codeblocktheme");
          if (eel) head.removeChild(eel);
          let el = document.createElement("link");
          el.id = "codeblocktheme";
          el.rel = "stylesheet";
          el.href = "../css/highlight/" + ev.data.codeBlockTheme + ".css";
          head.appendChild(el);

          eel = head.querySelector("#cssstyle");
          if (eel) head.removeChild(eel);
          el = document.createElement("style");
          el.id = "#cssstyle";
          el.innerHTML = ".remark-container { font-family: " + ev.data.font['font-family'] + "; "
            + "font-weight: " + ev.data.font['font-weight'] + "; "
            + "font-size: " + ev.data.font['font-size'] + "; "
            + "}";
          head.appendChild(el);

          eel = head.querySelector("#customcss");
          if (eel) head.removeChild(eel);
          el = document.createElement("style");
          el.id = "#customcss";
          el.innerHTML = ev.data.customCSS;
          head.appendChild(el);
          
          remark.create({
            converter: mdconverter,
            externalHighlighter: true
          });
        }
      });
    </script>
  </body>
</html>